

# Helm Chart Image Pull and Push Script

This script automates the process of pulling Docker images from a Helm chart and its subcharts, retagging them for a private registry, and consolidating them into a single `.tar` file. The script then allows you to push the images to your private registry. The names of the output files (rendered templates and the final image tarball) are dynamically generated based on the chart name.

---

## Prerequisites

Before running the script, ensure you have the following tools installed:

- **Docker**: For pulling, retagging, and saving Docker images.
  - [Install Docker](https://docs.docker.com/get-docker/)
  
- **Helm**: For rendering Helm charts to Kubernetes manifests.
  - [Install Helm](https://helm.sh/docs/intro/install/)
  
- **Linux/Mac OS (or WSL for Windows)**: This script has been tested on Linux and MacOS.

---

## Usage

### 1. **Clone the Repository or Copy the Script**

First, download or clone the script to your local machine.

```bash
git clone https://your-repository-url
cd your-repository-directory
```

### 2. **Configure the Script**

Before running the script, you need to specify your private registry and repository settings within the script:

- **PRIVATE_REGISTRY**: Set this to the address of your private Docker registry (e.g., `your-private-registry.local`).
- **LOCAL_REPO**: Specify the name of the repository in the private registry (e.g., `my-local-repo`).

```bash
PRIVATE_REGISTRY="your-private-registry.local"
LOCAL_REPO="your-local-repo"
```

### 3. **Run the Script**

To pull images from a Helm chart, retag them, and consolidate them into a `.tar` file, use the following command:

```bash
./helm-pull-script.sh <path_to_helm_chart>
```

- Replace `<path_to_helm_chart>` with the directory path to the Helm chart you wish to process.
- Example: `./helm-pull-script.sh ./charts/argo-cd`

### 4. **Output Files**

The script generates the following files in the `image_bundles` directory:

- **Rendered Templates**: The rendered Kubernetes YAML for the chart is saved as `<chart_name>-template.yaml`.
  - Example: `argo-cd-template.yaml`
  
- **Image Tarball**: All the Docker images pulled and retagged are consolidated into a tarball saved as `<chart_name>-images.tar`.
  - Example: `argo-cd-images.tar`

---

## Script Details

### 1. **Rendered Output**

The script renders the Helm chart into Kubernetes manifests (YAML). The rendered YAML is saved with the chart name and the `-template.yaml` suffix. This file contains the Kubernetes resources generated by Helm from the chart, which includes all the images used in the chart and its subcharts.

### 2. **Image Pulling and Retagging**

The script automatically:

- Extracts all Docker image names from the rendered Helm template.
- Pulls the images from the public registry (e.g., `docker.io`).
- Retags each image for the specified private registry (e.g., `your-private-registry.local/your-local-repo`).

### 3. **Saving Images**

After retagging the images, they are saved into a `.tar` file. This file can later be used to transfer or push the images to a private registry.

### 4. **Handling Subcharts**

The script supports charts with subcharts. It will render and process images from both the main chart and any subcharts.

### 5. **Error Handling**

- The script skips **library charts**, which are not installable.
- Invalid image references (such as broken or malformed image URLs) are skipped.
- The script prints debug information, including the image being processed, retagging steps, and any errors encountered.

---

## Push Images to Private Registry

### 1. **Push Script**

After pulling and retagging images, you can push them to your private registry using the following script (`push-images.sh`):

```bash
#!/bin/bash

PRIVATE_REGISTRY="your-private-registry.local"
LOCAL_REPO="your-local-repo"
FINAL_TARBALL="./image_bundles/${CHART_NAME}-images.tar"

# Check if Docker is installed
if ! command -v docker &> /dev/null; then
    echo "Docker is required but not installed. Please install it first."
    exit 1
fi

# Check if tarball exists
if [ ! -f "$FINAL_TARBALL" ]; then
    echo "Tarball $FINAL_TARBALL not found. Please ensure the tarball exists."
    exit 1
fi

# Load the tarball into Docker
echo "Loading images from $FINAL_TARBALL into Docker..."
docker load -i "$FINAL_TARBALL"

# Push images to the private registry
docker images --format "{{.Repository}}:{{.Tag}}" | while read image; do
    new_image="$PRIVATE_REGISTRY/$LOCAL_REPO/$image"
    echo "Pushing image $new_image..."
    docker push "$new_image"
done

echo "All images pushed to $PRIVATE_REGISTRY/$LOCAL_REPO."
```

### 2. **Run the Push Script**

To push the images:

```bash
chmod +x push-images.sh
./push-images.sh
```

This script will:

1. Load the images from the `.tar` file created by the first script.
2. Push each image to your private registry.

---

## Troubleshooting

- **No Images Found**: If no images are found, make sure that the Helm chart you are using contains image definitions in the format `image: <image-name>:<tag>`. The script assumes the images are defined this way.
  
- **Invalid Image Reference**: If you see messages like "Skipping invalid image reference", it typically means the image name or format is incorrect. Ensure that all image references follow the standard Docker image format: `repository/name:tag`.

- **Docker Errors**: Ensure that Docker is running and that you have sufficient privileges to pull and push images. You may need to run the script with elevated permissions if necessary.